<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>添加水印</title>
    <style>
      .test {
        background-color: red;
        width: 300px;
        height: 300px;
      }
    </style>
    <script>
            function loadScript(callback,src) {
              let script = document.createElement("script");
              script.src = src;

              console.info(' @#$ onload>>>>>>>>>',arguments,' this:',this)
              script.onload = () =>{
                callback?.(null, script,11,22)
              };
              script.onerror = () =>{
                console.info(' @#$ onerror',callback,' this:',this)
                callback(new Error(`Script load error for ${src}`));
              }

              document.head.append(script);
            }


          function promisify(f) {
            return function (...args) { // return a wrapper-function (*)
              console.info('第一个 args:',args,' this:',this,' f:',f) // aa1执行的时候被调用
              return new Promise((resolve, reject) => {
                function callback(err, ...result) { // our custom callback for f (**)
                  if (err) {
                    reject(err);
                  } else {
                    console.info(' result:',result,'...result',...result)
                    resolve(result);
                  }
                }

                // args.push(callback); // append our custom callback to the end of f arguments
                //this --> window
                console.info(' 41  args:',args);

                f.apply(`345d`,[callback,...args]); // call the original function
                // f.apply(`345d`,[...args,callback]); // call the original function
              });
            };
      }

      // usage:
      let loadScriptPromise = promisify(loadScript);
      console.info(' loadScriptPromise:',loadScriptPromise,performance.now().toFixed(2))
      console.info(' loadScript:',loadScript)
      // window.aa1 = loadScriptPromise('path/script.js');
      window.aa1 = loadScriptPromise('module/canvas.js','sda','ee',1).then((ee1,bb)=>{
        console.info('ee1',ee1,'bb:',bb,' this:',this)
      },(ee2)=>{
        console.info('ee2',ee2,performance.now().toFixed(2))
      })
    </script>
  </head>
  <body>
    toBlob
    <div class="test" onclick="alert(1)">
      test<a href="https://www.baidu.com">baidu</a>
    </div>
    <canvas id="canvas"></canvas>
    <p>
      <a
        href="https://levelup.gitconnected.com/how-to-add-a-watermark-to-your-website-with-html-canvas-f2c39474308a"
        >原文</a
      >
    </p>
    <script type="module" src="./module/addwatermark.js"></script>
  </body>
</html>
